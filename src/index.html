<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Converta UI</title>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';"/>
    <link rel="stylesheet" href="./styles.css">
</head>
<body>
<div id="title-bar">
    <span class="title">Converta UI</span>
    <nav>
        <div class="horizontal-divider-light"></div>
        <ul>
            <li class="chip" onclick="openTab('upload')">
                <div class="tooltip">
                    üì§
                    <span class="tooltiptext">Start Converting...</span>
                </div>
            </li>
            <li class="chip" onclick="openTab('converter')">
                üîÅ Converter
            </li>
            <li class="chip" onclick="openTab('settings')">
                ‚öôÔ∏è Settings
            </li>
        </ul>
        <div class="horizontal-divider-light"></div>
    </nav>
    <div class="toolbar-btns">
        <div id="minimize" class="toolbar-btn"></div>
        <div id="maximize" class="toolbar-btn"></div>
        <div id="close" class="toolbar-btn"></div>
    </div>
</div>
<div class="wrapper">
    <section id="section-upload">
        <h1>Convert a file or text</h1>
        <div>
            <button id="test-btn">Trigger Test Event</button>
        </div>
    </section>
    <section id="section-converter" style="display:none;">
        <h1>Manage Converter</h1>
        <div>
            <h2>Installed Converter</h2>
            <ul id="installed-packages-list" class="packages-list">
                <!-- Data gets injected here -->
            </ul>
            <div class="divider"></div>
            <h2>Downloadable Converter</h2>
            <ul id="download-packages-list" class="packages-list">
                <!-- Data gets injected here -->
            </ul>
        </div>
    </section>
    <section id="section-settings" style="display:none;">
        <h1>Settings</h1>
        <div>

        </div>
    </section>
</div>
<script>
	document.getElementById('minimize').addEventListener('click', () => {
		window.electron.minimizeWindow();
	});

	document.getElementById('maximize').addEventListener('click', () => {
		window.electron.maximizeWindow();
	});

	document.getElementById('close').addEventListener('click', () => {
		window.electron.closeWindow();
	});

	document.getElementById("test-btn").addEventListener('click', () => {
		window.electron.testing();
	});

	async function openTab(tab) {
		document.getElementById('section-upload').style.display = 'none';
		document.getElementById('section-converter').style.display = 'none';
		document.getElementById('section-settings').style.display = 'none';
		document.getElementById('section-' + tab).style.display = 'block';

		if (tab === 'converter') {
			await updatePackageLists();
		}
	}

	async function updatePackageLists() {
		await receiveInstalledPackages();
		await receiveDownloadablePackages();
	}

	async function receiveInstalledPackages() {
		const installedConverterPackages = await window.electron.getInstalledConverterPackages();
		const installedPackagesList = document.getElementById('installed-packages-list');
		installedPackagesList.innerHTML = '';

		installedConverterPackages.forEach((pkg) => {
			const uninstallBtn = document.createElement('button');
			uninstallBtn.innerText = 'Uninstall';
			uninstallBtn.onclick = async () => {
				const responseSucceed = await window.electron.uninstallConverterPackage(pkg);

				if (responseSucceed) {
					alert('Uninstalled ' + pkg.name + ' - ' + pkg.version);
					await updatePackageLists()
				} else {
					alert('Failed to uninstall ' + pkg.name + ' - ' + pkg.version);
				}
			};

			appendPackageListItem(installedPackagesList, pkg, uninstallBtn);
		});
	}

	async function receiveDownloadablePackages() {
		const downloadableConverterPackages = await window.electron.getDownloadableConverterPackages();
		const downloadPackagesList = document.getElementById('download-packages-list');
		downloadPackagesList.innerHTML = '';

		downloadableConverterPackages.forEach((pkg) => {
			const downloadBtn = document.createElement('button');
			downloadBtn.innerText = 'Download';
			downloadBtn.onclick = async () => {
				const responseSucceed = await window.electron.downloadConverterPackage(pkg);

				if (responseSucceed) {
					alert('Downloaded ' + pkg.name + ' - ' + pkg.version);
					await updatePackageLists()
				} else {
					alert('Failed to download ' + pkg.name + ' - ' + pkg.version);
				}
			};

			appendPackageListItem(downloadPackagesList, pkg, downloadBtn);
		});
	}

	function appendPackageListItem(listElement, pkg, button) {
		const li = document.createElement('li');
		li.classList.add('packages-list-item');

		const textDiv = document.createElement('div');
		textDiv.classList.add('text');

		const title = document.createElement('h3');
		title.innerText = pkg.name + " - " + pkg.version;
		textDiv.appendChild(title);

		const description = document.createElement('span');
		description.innerText = pkg.description;
		textDiv.appendChild(description);

		li.appendChild(textDiv);
		li.appendChild(button);
		listElement.appendChild(li);
	}
</script>
</body>
</html>